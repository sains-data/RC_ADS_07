```{r setup, include=FALSE}
# Atur global options untuk suppress warnings
knitr::opts_chunk$set(
  warning = FALSE, 
  message = FALSE, 
  echo = TRUE,
  comment = ""  # Hilangkan ## di output
)
```

```{r libraries}
# LIBRARY
library(dplyr)
library(ggplot2)
library(car)
library(ggpubr)
library(tidyr)
library(rstatix)
library(dunn.test) # Untuk alternatif Dunn test
```

```{r hipotesis}
# HIPOTESIS STATISTIK
cat("ðŸŽ¯ HIPOTESIS PENELITIAN:\n")
cat("H0: Tidak ada perbedaan rata-rata pengeluaran makanan yang signifikan antara mahasiswa yang tinggal di Rumah, Kos, dan Asrama\n")
cat("H1: Ada perbedaan rata-rata pengeluaran makanan yang signifikan antara setidaknya dua kelompok tempat tinggal\n")
cat("Î± = 0.05\n\n")
```

## 1. PREPARASI DATA

```{r data-preparation}
# Baca data
data <- read.csv("D:/Dokumen/Kode 00B/Tubes ADS/data/Dataset Tugas Besar ADS 2025.csv", stringsAsFactors = FALSE)

# Tampilkan struktur data untuk memahami kolom yang tersedia
cat("STRUKTUR DATA:\n")
str(data)

# Identifikasi kolom yang relevan
uang_saku_col <- "Uang.Saku.....yang.diberikan.oleh.orangtua."
tempat_tinggal_col <- "Jenis.Tempat.Tinggal.....Tempat.tinggal.saat.ini.."

# Preprocessing data
data_clean <- data %>%
  select(uang_saku = all_of(uang_saku_col), 
         tempat_tinggal = all_of(tempat_tinggal_col)) %>%
  mutate(
    # Konversi uang saku ke numeric
    uang_saku_numeric = case_when(
      grepl("500k", uang_saku, ignore.case = TRUE) ~ 750000,
      grepl("1 jt s.d 1,5 jt", uang_saku, ignore.case = TRUE) ~ 1250000,
      grepl("1,5 jt s.d 2 jt", uang_saku, ignore.case = TRUE) ~ 1750000,
      grepl("> 2 jt", uang_saku, ignore.case = TRUE) ~ 2500000,
      TRUE ~ NA_real_
    ),
    
    # Kelompokkan tempat tinggal menjadi 3 kategori utama
    tempat_tinggal_group = case_when(
      grepl("orangtua|Rumah mengontrak Pribadi", tempat_tinggal, ignore.case = TRUE) ~ "Rumah",
      grepl("Kos", tempat_tinggal, ignore.case = TRUE) ~ "Kos", 
      grepl("Asrama", tempat_tinggal, ignore.case = TRUE) ~ "Asrama",
      TRUE ~ NA_character_
    )
  ) %>%
  # Filter data valid
  filter(!is.na(tempat_tinggal_group),
         !is.na(uang_saku_numeric))

# Tampilkan jumlah sampel per kelompok
cat("\nSAMPEL ANALISIS PER KELOMPOK:\n")
print(table(data_clean$tempat_tinggal_group))

# Tampilkan ringkasan data
cat("\nRINGKASAN DATA:\n")
print(head(data_clean))
```

## 2. STATISTIK DESKRIPTIF

```{r descriptive-stats}
# Hitung statistik deskriptif
desc_stats <- data_clean %>%
  group_by(tempat_tinggal_group) %>%
  summarise(
    n = n(),
    mean = mean(uang_saku_numeric),
    sd = sd(uang_saku_numeric),
    median = median(uang_saku_numeric),
    min = min(uang_saku_numeric),
    max = max(uang_saku_numeric),
    .groups = "drop"
  ) %>%
  mutate(
    mean_formatted = paste0("Rp ", format(round(mean, 0), big.mark = ".")),
    sd_formatted = paste0("Rp ", format(round(sd, 0), big.mark = "."))
  )

cat("\nðŸ“Š STATISTIK DESKRIPTIF PER KELOMPOK:\n")
print(desc_stats %>% 
        select(tempat_tinggal_group, n, mean_formatted, sd_formatted, 
               median, min, max))

# Visualisasi distribusi data
ggplot(data_clean, aes(x = tempat_tinggal_group, y = uang_saku_numeric, fill = tempat_tinggal_group)) +
  geom_boxplot(alpha = 0.7, outlier.shape = 16, outlier.size = 2) +
  geom_jitter(width = 0.2, alpha = 0.6, size = 2) +
  stat_summary(fun = mean, geom = "point", shape = 23, size = 3, fill = "red") +
  labs(
    title = "Distribusi Pengeluaran Uang Saku Berdasarkan Tempat Tinggal",
    x = "Tempat Tinggal",
    y = "Uang Saku (Rupiah)",
    fill = "Tempat Tinggal"
  ) +
  scale_y_continuous(labels = scales::comma) +
  theme_minimal() +
  theme(
    plot.title = element_text(face = "bold", hjust = 0.5),
    legend.position = "none"
  )
```

## 3. UJI ASUMSI ANOVA

```{r anova-assumptions}
cat("\nðŸ”¬ UJI ASUMSI ANOVA:\n")

# Asumsi 1: Normalitas (Shapiro-Wilk test pada residual)
model_anova <- aov(uang_saku_numeric ~ tempat_tinggal_group, data = data_clean)
shapiro_test <- shapiro.test(residuals(model_anova))
cat("\nâ€¢ Uji Normalitas (Shapiro-Wilk):\n")
cat("  Statistik W =", round(shapiro_test$statistic, 4), 
    "| p-value =", format.pval(shapiro_test$p.value, digits = 4), "\n")
if(shapiro_test$p.value < 0.05) {
  cat("  âŒ Asumsi normalitas TIDAK terpenuhi (p <", format.pval(shapiro_test$p.value, digits = 4), ")\n")
  cat("  ðŸ“Œ Rekomendasi: Pertimbangkan penggunaan uji non-parametrik (Kruskal-Wallis)\n")
} else {
  cat("  âœ… Asumsi normalitas terpenuhi\n")
}

# Plot QQ-plot untuk visualisasi normalitas
ggplot(data.frame(res = residuals(model_anova)), aes(sample = res)) +
  stat_qq() +
  stat_qq_line(color = "red") +
  labs(title = "QQ-Plot: Uji Normalitas Residual",
       x = "Teoretical Quantiles", 
       y = "Sample Quantiles") +
  theme_minimal()

# Asumsi 2: Homogenitas Varians (Levene's Test)
levene_test <- leveneTest(uang_saku_numeric ~ tempat_tinggal_group, data = data_clean)
cat("\nâ€¢ Uji Homogenitas Varians (Levene):\n")
cat("  F-statistik =", round(levene_test$"F value"[1], 4), 
    "| p-value =", format.pval(levene_test$"Pr(>F)"[1], digits = 4), "\n")
if(levene_test$"Pr(>F)"[1] < 0.05) {
  cat("  âŒ Asumsi homogenitas varians TIDAK terpenuhi (p <", format.pval(levene_test$"Pr(>F)"[1], digits = 4), ")\n")
  cat("  ðŸ“Œ Rekomendasi: Pertimbangkan penggunaan Welch ANOVA atau uji non-parametrik\n")
} else {
  cat("  âœ… Asumsi homogenitas varians terpenuhi\n")
}

# Plot untuk memeriksa homogenitas varians
ggplot(data_clean, aes(x = tempat_tinggal_group, y = uang_saku_numeric, fill = tempat_tinggal_group)) +
  geom_boxplot(alpha = 0.7) +
  labs(title = "Perbandingan Varians Antar Kelompok",
       x = "Tempat Tinggal",
       y = "Uang Saku (Rupiah)") +
  theme_minimal() +
  theme(legend.position = "none")
```

## 4. ANALISIS ANOVA

```{r anova-analysis}
cat("\nðŸ“Š ANALISIS ANOVA:\n")

# Uji ANOVA reguler
anova_result <- aov(uang_saku_numeric ~ tempat_tinggal_group, data = data_clean)
anova_table <- summary(anova_result)

cat("\nTABEL ANOVA LENGKAP:\n")
print(anova_table)

# Ekstrak nilai F dan p-value
f_value <- anova_table[[1]]$"F value"[1]
p_value <- anova_table[[1]]$"Pr(>F)"[1]

cat("\nðŸ“‹ INTERPRETASI HASIL ANOVA:\n")
cat("â€¢ F-statistik =", round(f_value, 4), "\n")
cat("â€¢ p-value =", format.pval(p_value, digits = 4), "\n")

# Visualisasi hasil ANOVA
plot_data <- data_clean %>%
  group_by(tempat_tinggal_group) %>%
  summarise(mean = mean(uang_saku_numeric),
            se = sd(uang_saku_numeric) / sqrt(n()),
            .groups = "drop")

ggplot(plot_data, aes(x = tempat_tinggal_group, y = mean, fill = tempat_tinggal_group)) +
  geom_col(alpha = 0.8) +
  geom_errorbar(aes(ymin = mean - se, ymax = mean + se), width = 0.2) +
  geom_text(aes(label = paste0("Rp ", format(round(mean, 0), big.mark = "."))),
            vjust = -0.5, size = 3.5) +
  labs(
    title = "Rata-rata Uang Saku per Tempat Tinggal",
    subtitle = paste("F =", round(f_value, 2), "| p =", format.pval(p_value, digits = 4)),
    x = "Tempat Tinggal",
    y = "Rata-rata Uang Saku (Rupiah)",
    fill = "Tempat Tinggal"
  ) +
  scale_y_continuous(labels = scales::comma) +
  scale_fill_brewer(palette = "Set2") +
  theme_minimal() +
  theme(
    plot.title = element_text(face = "bold", hjust = 0.5),
    plot.subtitle = element_text(color = ifelse(p_value < 0.05, "red", "blue")),
    legend.position = "none"
  )

# Keputusan berdasarkan hasil ANOVA
alpha <- 0.05
if(p_value < alpha) {
  cat("â€¢ KEPUTUSAN: Tolak H0 (p <", alpha, ")\n")
  cat("â€¢ KESIMPULAN: Terdapat perbedaan signifikan rata-rata uang saku antara kelompok tempat tinggal\n")
  
  # Uji Post-Hoc (Tukey HSD)
  cat("\nðŸ” UJI POST-HOC (Tukey HSD):\n")
  tukey_result <- TukeyHSD(anova_result)
  print(tukey_result)
  
  # Ekstrak dan visualisasi hasil post-hoc
  tukey_df <- as.data.frame(tukey_result$tempat_tinggal_group) %>%
    tibble::rownames_to_column("comparison") %>%
    mutate(
      group1 = sapply(strsplit(comparison, "-"), `[`, 1),
      group2 = sapply(strsplit(comparison, "-"), `[`, 2),
      significance = case_when(
        `p adj` < 0.001 ~ "***",
        `p adj` < 0.01 ~ "**",
        `p adj` < 0.05 ~ "*",
        TRUE ~ "ns"
      )
    )
  
  # Tampilkan perbandingan signifikan
  cat("\nðŸ“‹ PERBANDINGAN YANG SIGNIFIKAN:\n")
  signif_comps <- tukey_df %>% filter(`p adj` < 0.05)
  if(nrow(signif_comps) > 0) {
    for(i in 1:nrow(signif_comps)) {
      cat(sprintf("â€¢ %s vs %s: p = %s\n", 
                  signif_comps$group1[i], 
                  signif_comps$group2[i],
                  format.pval(signif_comps$`p adj`[i], digits = 4)))
    }
  } else {
    cat("â€¢ Tidak ada perbandingan yang signifikan setelah koreksi\n")
  }
  
} else {
  cat("â€¢ KEPUTUSAN: Gagal tolak H0 (p >", alpha, ")\n")
  cat("â€¢ KESIMPULAN: Tidak terdapat perbedaan signifikan rata-rata uang saku antara kelompok tempat tinggal\n")
}
```

## 5. ANALISIS ALTERNATIF (KRUSKAL-WALLIS)

```{r non-parametric}
# Karena asumsi ANOVA mungkin tidak terpenuhi, lakukan uji non-parametrik sebagai perbandingan
cat("\nðŸ”„ ANALISIS ALTERNATIF (KRUSKAL-WALLIS):\n")
kruskal_result <- kruskal.test(uang_saku_numeric ~ tempat_tinggal_group, data = data_clean)
cat("Statistik Kruskal-Wallis:", round(kruskal_result$statistic, 4), "\n")
cat("p-value:", format.pval(kruskal_result$p.value, digits = 4), "\n")

if(kruskal_result$p.value < 0.05) {
  cat("â€¢ KEPUTUSAN: Tolak H0 untuk uji Kruskal-Wallis\n")
  cat("â€¢ KESIMPULAN: Terdapat perbedaan signifikan distribusi uang saku antara kelompok tempat tinggal\n")
  
  # Uji post-hoc untuk Kruskal-Wallis (dua opsi)
  cat("\nUJI POST-HOC DUNN:\n")
  cat("Opsi 1: Menggunakan package rstatix\n")
  dunn_result1 <- data_clean %>%
    dunn_test(uang_saku_numeric ~ tempat_tinggal_group, p.adjust.method = "bonferroni")
  print(dunn_result1)
  
  cat("\nOpsi 2: Menggunakan package dunn.test\n")
  dunn_result2 <- dunn.test(data_clean$uang_saku_numeric, data_clean$tempat_tinggal_group, method = "bonferroni")
  # Hasil dari dunn.test sudah otomatis ditampilkan
  
} else {
  cat("â€¢ KEPUTUSAN: Gagal tolak H0 untuk uji Kruskal-Wallis\n")
  cat("â€¢ KESIMPULAN: Tidak terdapat perbedaan signifikan distribusi uang saku antara kelompok tempat tinggal\n")
}
```

## 6. SIMPULAN AKHIR

```{r conclusion}
cat("\nðŸŽ¯ SIMPULAN AKHIR:\n")

# Ringkasan hasil
if(p_value < 0.05 & kruskal_result$p.value < 0.05) {
  cat("âœ… Terdapat bukti kuat bahwa tempat tinggal berpengaruh terhadap besarnya uang saku mahasiswa\n")
  cat("â€¢ Perbedaan signifikan ditemukan baik menggunakan ANOVA maupun Kruskal-Wallis\n")
  cat("â€¢ Rekomendasi: Lakukan analisis lebih mendalam untuk mengetahui pola pengeluaran per kelompok\n")
} else if(p_value < 0.05) {
  cat("ðŸŸ¡ Terdapat bukti cukup bahwa tempat tinggal berpengaruh terhadap besarnya uang saku mahasiswa\n")
  cat("â€¢ Perbedaan signifikan ditemukan dengan ANOVA tetapi asumsi mungkin tidak terpenuhi\n")
  cat("â€¢ Rekomendasi: Pertimbangkan hasil uji Kruskal-Wallis sebagai analisis utama\n")
} else if(kruskal_result$p.value < 0.05) {
  cat("ðŸŸ¡ Terdapat bukti cukup bahwa tempat tinggal berpengaruh terhadap besarnya uang saku mahasiswa\n")
  cat("â€¢ Perbedaan signifikan ditemukan dengan uji Kruskal-Wallis\n")
  cat("â€¢ Rekomendasi: Gunakan hasil non-parametrik sebagai kesimpulan utama\n")
} else {
  cat("âŒ Tidak terdapat bukti yang cukup bahwa tempat tinggal berpengaruh terhadap besarnya uang saku mahasiswa\n")
  cat("â€¢ Tidak ada perbedaan signifikan yang ditemukan baik menggunakan ANOVA maupun Kruskal-Wallis\n")
  cat("â€¢ Rekomendasi: Telusuri variabel lain yang mungkin lebih berpengaruh\n")
}

# Catatan metodologis
cat("\nðŸ“ CATATAN METODOLOGIS:\n")
cat("â€¢ Analisis dilakukan berdasarkan data uang saku karena data pengeluaran makanan tidak tersedia di dataset\n")
cat("â€¢ Diasumsikan bahwa uang saku berkorelasi dengan pengeluaran makanan mahasiswa\n")
cat("â€¢ Untuk penelitian lanjutan, disarankan mengumpulkan data langsung tentang pengeluaran makanan\n")
```


Berikut kode blok yang dapat Anda tambahkan di bawah kode yang sudah ada untuk mengekspor hasil analisis ke file CSV:

```{r export-results}
# Buat folder hasil jika belum ada
if(!dir.exists("hasil_analisis")) {
  dir.create("hasil_analisis")
}

# 1. Ekspor data yang sudah dibersihkan
write.csv(data_clean, "hasil_analisis/data_bersih.csv", row.names = FALSE)

# 2. Ekspor statistik deskriptif
desc_stats_export <- data_clean %>%
  group_by(tempat_tinggal_group) %>%
  summarise(
    n = n(),
    mean = mean(uang_saku_numeric),
    sd = sd(uang_saku_numeric),
    median = median(uang_saku_numeric),
    min = min(uang_saku_numeric),
    max = max(uang_saku_numeric)
  )
write.csv(desc_stats_export, "hasil_analisis/statistik_deskriptif.csv", row.names = FALSE)

# 3. Ekspor hasil ANOVA
if(exists("model_anova")) {
  anova_results <- broom::tidy(model_anova)
  write.csv(anova_results, "hasil_analisis/hasil_anova.csv", row.names = FALSE)
}

# 4. Ekspor hasil Kruskal-Wallis
if(exists("kruskal_result")) {
  kruskal_df <- data.frame(
    test = "Kruskal-Wallis",
    statistic = kruskal_result$statistic,
    parameter = kruskal_result$parameter,
    p_value = kruskal_result$p.value,
    method = kruskal_result$method
  )
  write.csv(kruskal_df, "hasil_analisis/hasil_kruskal.csv", row.names = FALSE)
}

# 5. Ekspor hasil post-hoc jika tersedia
if(exists("tukey_result")) {
  tukey_export <- as.data.frame(tukey_result$tempat_tinggal_group)
  write.csv(tukey_export, "hasil_analisis/hasil_posthoc_tukey.csv", row.names = FALSE)
}

# 6. Ekspor data visualisasi rata-rata per kelompok
vis_data <- data_clean %>%
  group_by(tempat_tinggal_group) %>%
  summarise(mean_uang = mean(uang_saku_numeric)) %>%
  ungroup()
write.csv(vis_data, "hasil_analisis/data_visualisasi.csv", row.names = FALSE)

# 7. Ringkasan hasil ke file teks
sink("hasil_analisis/ringkasan_hasil.txt")
cat("RINGKASAN HASIL ANALISIS\n")
cat("========================\n\n")
cat("Judul Analisis: Perbedaan Rata-Rata Pengeluaran Makanan Mahasiswa Berdasarkan Tempat Tinggal\n")
cat("Metode Analisis: ANOVA dan Kruskal-Wallis\n\n")

cat("Jumlah Sampel per Kelompok:\n")
print(table(data_clean$tempat_tinggal_group))

if(exists("p_value") && exists("alpha")) {
  cat("\nKeputusan Hipotesis:\n")
  if(p_value < alpha) {
    cat("- KEPUTUSAN: Tolak H0\n")
    cat("- KESIMPULAN: Terdapat perbedaan signifikan\n")
  } else {
    cat("- KEPUTUSAN: Gagal tolak H0\n")
    cat("- KESIMPULAN: Tidak terdapat perbedaan signifikan\n")
  }
  cat(sprintf("- p-value: %f\n", p_value))
}

cat("\nFile yang dihasilkan:\n")
cat("- data_bersih.csv: Data yang sudah dibersihkan\n")
cat("- statistik_deskriptif.csv: Statistik per kelompok\n")
cat("- hasil_anova.csv: Tabel ANOVA lengkap\n")
cat("- hasil_kruskal.csv: Hasil uji Kruskal-Wallis\n")
cat("- hasil_posthoc_tukey.csv: Hasil uji post-hoc Tukey (jika tersedia)\n")
cat("- data_visualisasi.csv: Data untuk visualisasi\n")
cat("- ringkasan_hasil.txt: File ini\n")
sink()

cat("\nâœ… Semua hasil analisis telah diekspor ke folder 'hasil_analisis'\n")
```